<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 趨勢圖表分析工具</title>
    <meta name="description" content="專業的 Excel 數據篩選、排序與趨勢圖表視覺化工具">

    <!-- Modern Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📊</text></svg>">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Alpine.js (for simple tooltips/modals) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- SheetJS (Excel Parsing) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Plotly.js (Charting) -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- KaTeX (Math Rendering) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
</head>

<body class="dark-mode">
    <div class="app-container">
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="card-icon blue">
                        <span class="material-icons-round">list_alt</span>
                    </div>
                    <div class="card-info">
                        <label>總數據筆數</label>
                        <span id="total-rows">0</span>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon green">
                        <span class="material-icons-round">filter_list</span>
                    </div>
                    <div class="card-info">
                        <label>篩選後筆數</label>
                        <span id="filtered-rows">0</span>
                    </div>
                </div>
                <div class="summary-card stats-group-card">
                    <div class="mini-stats-grid">
                        <div class="mini-stat" data-formula="C_a = \frac{\bar{X} - \text{Target}}{T/2}">
                            <label>Ca</label>
                            <span id="ca-value">N/A</span>
                        </div>
                        <div class="mini-stat"
                            data-formula="C_p = \frac{\text{USL} - \text{LSL}}{6\sigma_{\text{within}}}">
                            <label>Cp</label>
                            <span id="cp-value">N/A</span>
                        </div>
                        <div class="mini-stat" data-formula="C_{pk} = C_p(1 - |C_a|)">
                            <label>Cpk</label>
                            <span id="cpk-value">N/A</span>
                        </div>
                        <div class="mini-stat"
                            data-formula="P_{pk} = \min\left(\frac{\text{USL} - \bar{X}}{3\sigma_{\text{overall}}}, \frac{\bar{X} - \text{LSL}}{3\sigma_{\text{overall}}}\right)">
                            <label>Ppk</label>
                            <span id="ppk-value">N/A</span>
                        </div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon amber">
                        <span class="material-icons-round">functions</span>
                    </div>
                    <div class="card-info" data-formula="UCL/LCL = \bar{X} \pm 3\sigma_{\text{within}}">
                        <label>平均值 / 管制界限 (UCL/LCL)</label>
                        <span id="y-mean">0</span>
                        <div class="sub-text" id="cl-text">UCL: - | LCL: -</div>
                    </div>
                </div>
                <div class="summary-card dev-card">
                    <div class="card-info">
                        <label>標準差 (StdDev)</label>
                        <div class="dev-stats">
                            <div class="dev-item" data-formula="\sigma_{within} = \frac{\overline{MR}}{d_2}, d_2=1.128">
                                <span>組內:</span><b id="sd-within">-</b>
                            </div>
                            <div class="dev-item"
                                data-formula="\sigma_{between} = \sqrt{\sigma_{overall}^2 - \sigma_{within}^2}">
                                <span>組間:</span><b id="sd-between">-</b>
                            </div>
                            <div class="dev-item"
                                data-formula="\sigma_{overall} = \sqrt{\frac{\sum(X_i - \bar{X})^2}{N-1}}">
                                <span>總體:</span><b id="sd-overall">-</b>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help & Formula Explanation (Modal) -->
            <div id="help-modal" class="modal-overlay hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>參數與指標說明</h2>
                        <button id="close-help" class="icon-button"><span
                                class="material-icons-round">close</span></button>
                    </div>
                    <div class="modal-body">
                        <div class="help-section">
                            <h3>品質能力指標</h3>
                            <ul>
                                <li><b>Ca (Accuracy):</b> 衡量平均值偏離中心值程度。|Ca| &lt; 12.5% 為優級。</li>
                                <li><b>Cp (Precision):</b> 衡量數據離散程度。Cp = (USL-LSL) / 6σ_within。</li>
                                <li><b>Cpk (Potential Capability):</b> 同時考慮偏移與離散。Cpk = Cp * (1 - |Ca|)。</li>
                                <li><b>Ppk (Performance):</b> 實際製程績效。使用 σ_overall 計算。</li>
                            </ul>
                        </div>
                        <div class="help-section">
                            <h3>標準差 (Standard Deviation)</h3>
                            <ul>
                                <li><b>σ_Within (組內):</b> 反映製程短期穩定性，通常基於移動極差 (MR)。</li>
                                <li><b>σ_Overall (總體):</b> 所有數據的樣本標準差，反映整體變異。</li>
                                <li><b>σ_Between (組間):</b> σ_Between = √(σ_Overall² - σ_Within²)，反映批次間的波動。</li>
                            </ul>
                        </div>
                        <div class="help-section">
                            <h3>管制界限 (Control Limits)</h3>
                            <ul>
                                <li><b>CL (Center Line):</b> 數據平均值。</li>
                                <li><b>UCL/LCL:</b> ±3 * σ_Within。反映 99.73% 的數據分佈範圍。</li>
                            </ul>
                        </div>
                        <div class="help-section">
                            <h3>數據管理與操作</h3>
                            <ul>
                                <li><b>狀態持久化：</b> 系統會自動記憶您的工作表選擇、圖表軸向與篩選條件。更換檔案或切換工作表時，只要欄位名稱匹配，設定將自動套用。</li>
                                <li><b>數據預覽：</b> 採用高效能技術載入所有篩選數據。若數據量較大，會隨著捲動自動加載。</li>
                                <li><b>多表拼接：</b> 在選擇工作表時按住 Ctrl，可將多個表單的數據直向合併為單一數據源進行分析。</li>
                            </ul>
                        </div>
                        <div class="help-section">
                            <h3>快捷操作技巧</h3>
                            <ul>
                                <li><b>圖表縮放：</b> 在圖表上按住左鍵拖曳可放大特定區域，雙擊滑鼠可重置縮放。</li>
                                <li><b>快速篩選：</b> 每次更換篩選條件，上方統計數值與下方表格將同步即時更新。</li>
                                <li><b>統計導出：</b> 提供 PNG 格式圖表下載與篩選後數據的 Excel 匯出功能。</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div id="charts-main-container" class="charts-grid dual-view">
                <!-- Trend Chart Card -->
                <div id="trend-card" class="content-card chart-container">
                    <div class="card-header">
                        <h3 class="card-title">數據趨勢圖</h3>
                        <div class="card-actions">
                            <button id="export-trend" class="icon-button" title="下載圖表">
                                <span class="material-icons-round">download</span>
                            </button>
                        </div>
                    </div>
                    <div id="plotly-trend" class="chart-box">
                        <div class="empty-state">
                            <span class="material-icons-round">insights</span>
                            <p>請先上傳檔案並選擇數據欄位</p>
                        </div>
                    </div>
                </div>

                <!-- Normal Distribution Card -->
                <div id="dist-card" class="content-card chart-container">
                    <div class="card-header">
                        <h3 class="card-title">常態分佈分析</h3>
                        <div class="card-actions">
                            <button id="export-dist" class="icon-button" title="下載圖表">
                                <span class="material-icons-round">download</span>
                            </button>
                        </div>
                    </div>
                    <div id="plotly-dist" class="chart-box">
                        <div class="empty-state">
                            <span class="material-icons-round">bar_chart</span>
                            <p>選擇數據後自動生成</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="content-card table-container">
                <div class="card-header">
                    <h3 class="card-title">數據預覽 <span id="table-count"
                            style="font-size: 0.75rem; font-weight: normal; margin-left: 8px; opacity: 0.7;"></span>
                    </h3>
                    <div class="card-actions">
                        <button id="export-csv" class="secondary-button size-sm">
                            匯出篩選數據
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="data-table">
                        <thead>
                            <tr id="table-head"></tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Sidebar / Control Panel -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <div class="logo">
                    <span class="material-icons-round">analytics</span>
                    <h1>TrendChart Pro</h1>
                </div>
            </header>

            <div class="control-sections">
                <!-- File Upload -->
                <section class="control-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">upload_file</span>
                        資料導入
                    </h2>
                    <div id="drop-zone" class="drop-zone">
                        <input type="file" id="file-input" accept=".xlsx, .xls" hidden>
                        <span class="material-icons-round">cloud_upload</span>
                        <p>拖放 Excel 檔案或點擊上傳</p>
                    </div>
                    <div id="file-info" class="file-info hidden">
                        <span class="material-icons-round">description</span>
                        <span id="filename">filename.xlsx</span>
                        <button id="remove-file" class="icon-button">
                            <span class="material-icons-round">close</span>
                        </button>
                    </div>
                </section>

                <!-- Worksheet Selection -->
                <section class="control-section hidden" id="sheet-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">layers</span>
                        選擇工作表
                    </h2>
                    <select id="sheet-selector" class="custom-select" multiple></select>
                    <small class="hint">按住 Ctrl 可選擇多個工作表進行數據拼接</small>
                </section>

                <!-- Column Configuration -->
                <section class="control-section hidden" id="config-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">settings</span>
                        圖表設定
                    </h2>
                    <div class="config-group">
                        <label>主 X 軸欄位 (底部)</label>
                        <select id="x-axis-selector" class="custom-select"></select>
                    </div>
                    <div class="config-group">
                        <label>副 X 軸欄位 (頂部)</label>
                        <select id="x-axis-2-selector" class="custom-select">
                            <option value="">無</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <label>Y 軸欄位 (數值數據)</label>
                        <select id="y-axis-selector" class="custom-select" multiple></select>
                        <small class="hint">按住 Ctrl 可多選</small>
                    </div>

                    <div id="y-visibility-section" class="config-group hidden">
                        <label>顯示切換 (快速勾選)</label>
                        <div id="y-series-toggles" class="checkbox-list-container"></div>
                    </div>

                    <!-- Spec Limits Section -->
                    <div class="spec-limits-container">
                        <div class="config-group">
                            <label>目標值 (Target)</label>
                            <div class="input-with-select">
                                <input type="number" id="target-input" class="custom-input" placeholder="手動輸入">
                                <select id="target-col-selector" class="custom-select col-pick" title="從欄位選取">
                                    <option value="">選取欄位</option>
                                </select>
                            </div>
                        </div>
                        <div class="config-group">
                            <label>規格上限 (USL)</label>
                            <div class="input-with-select">
                                <input type="number" id="usl-input" class="custom-input" placeholder="手動輸入">
                                <select id="usl-col-selector" class="custom-select col-pick" title="從欄位選取">
                                    <option value="">選取欄位</option>
                                </select>
                            </div>
                        </div>
                        <div class="config-group">
                            <label>規格下限 (LSL)</label>
                            <div class="input-with-select">
                                <input type="number" id="lsl-input" class="custom-input" placeholder="手動輸入">
                                <select id="lsl-col-selector" class="custom-select col-pick" title="從欄位選取">
                                    <option value="">選取欄位</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="generate-chart" class="primary-button">
                            <span class="material-icons-round">refresh</span>
                            更新圖表
                        </button>
                    </div>
                </section>

                <!-- Layout Config -->
                <section class="control-section hidden" id="layout-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">dashboard</span>
                        佈局設定
                    </h2>
                    <div class="layout-toggles">
                        <label class="checkbox-label">
                            <input type="checkbox" id="toggle-trend" checked>
                            <span>顯示趨勢圖</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="toggle-dist" checked>
                            <span>顯示常態分析</span>
                        </label>
                    </div>
                </section>

                <!-- Filtering -->
                <section class="control-section hidden" id="filter-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">filter_alt</span>
                        數據篩選
                    </h2>
                    <div id="filter-container" class="filter-container">
                        <!-- Filters will be generated dynamically -->
                    </div>
                    <button id="reset-filters" class="secondary-button size-sm">
                        清除所有篩選
                    </button>
                </section>

                <!-- Author Info -->
                <section class="control-section">
                    <h2 class="section-title">
                        <span class="material-icons-round">person_outline</span>
                        作者資訊
                    </h2>
                    <div class="author-card">
                        <p class="author-name">Wesley Chang, 2026-01-16.</p>
                        <p class="author-label">Mouldex Inc. / Quality Control Dept.</p>
                    </div>
                </section>
            </div>

            <footer class="sidebar-footer">
                <button id="show-help" class="icon-button" title="參數說明">
                    <span class="material-icons-round">help_outline</span>
                </button>
                <button id="theme-toggle" class="icon-button">
                    <span class="material-icons-round">dark_mode</span>
                </button>
                <span class="version">v1.0.0</span>
            </footer>
        </aside>
    </div>

    <!-- Formula Tooltip Container -->
    <div id="formula-tooltip" class="formula-tooltip hidden"></div>

    <!-- Scripts -->
    <script src="js/excelParser.js"></script>
    <script src="js/chartRenderer.js"></script>
    <script src="js/app.js"></script>
</body>

</html>